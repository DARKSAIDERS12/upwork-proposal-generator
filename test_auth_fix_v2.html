<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ v2</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ v2</h1>
    
    <div class="test-section">
        <h2>üìä –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å</h2>
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar"></div>
        </div>
        <div id="progressText">0%</div>
    </div>
    
    <div class="test-section">
        <h2>1. üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Supabase SDK</h2>
        <div id="supabaseStatus" class="status info">–ü—Ä–æ–≤–µ—Ä—è–µ–º...</div>
        <button onclick="checkSupabase()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Supabase</button>
        <div class="log" id="supabaseLog"></div>
    </div>
    
    <div class="test-section">
        <h2>2. üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</h2>
        <div id="authFunctionsStatus" class="status info">–ü—Ä–æ–≤–µ—Ä—è–µ–º...</div>
        <button onclick="checkAuthFunctions()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏</button>
        <div class="log" id="authFunctionsLog"></div>
    </div>
    
    <div class="test-section">
        <h2>3. üöÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏</h2>
        <div id="initializationStatus" class="status info">–ü—Ä–æ–≤–µ—Ä—è–µ–º...</div>
        <button onclick="checkInitialization()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é</button>
        <div class="log" id="initializationLog"></div>
    </div>
    
    <div class="test-section">
        <h2>4. üìù –¢–µ—Å—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</h2>
        <input type="email" id="testEmail" placeholder="test@example.com" value="test@example.com">
        <input type="password" id="testPassword" placeholder="password123" value="password123">
        <button onclick="testRegistration()" id="registerBtn">–¢–µ—Å—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</button>
        <div id="registrationResult"></div>
    </div>
    
    <div class="test-section">
        <h2>5. üîë –¢–µ—Å—Ç –≤—Ö–æ–¥–∞</h2>
        <button onclick="testLogin()" id="loginBtn">–¢–µ—Å—Ç –≤—Ö–æ–¥–∞</button>
        <div id="loginResult"></div>
    </div>
    
    <div class="test-section">
        <h2>6. üö™ –¢–µ—Å—Ç –≤—ã—Ö–æ–¥–∞</h2>
        <button onclick="testLogout()" id="logoutBtn">–¢–µ—Å—Ç –≤—ã—Ö–æ–¥–∞</button>
        <div id="logoutResult"></div>
    </div>
    
    <div class="test-section">
        <h2>7. üë§ –°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
        <div id="userStatus" class="status info">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</div>
        <button onclick="checkUserStatus()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
    </div>
    
    <div class="test-section">
        <h2>8. üßπ –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h2>
        <button onclick="runFullDiagnostic()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</button>
        <div class="log" id="diagnosticLog"></div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Auth.js -->
    <script src="auth.js"></script>
    
    <script>
        let progress = 0;
        const totalTests = 8;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function updateProgress(increment = 1) {
            progress += increment;
            const percentage = Math.round((progress / totalTests) * 100);
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressText').textContent = percentage + '%';
        }
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        function logTo(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                const timestamp = new Date().toLocaleTimeString();
                element.innerHTML += `[${timestamp}] ${message}\n`;
                element.scrollTop = element.scrollHeight;
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ Supabase SDK
        function checkSupabase() {
            const status = document.getElementById('supabaseStatus');
            const log = 'supabaseLog';
            
            logTo(log, 'üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É Supabase SDK...');
            
            if (typeof createClient !== 'undefined') {
                status.className = 'status success';
                status.textContent = '‚úÖ Supabase SDK –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ';
                logTo(log, '‚úÖ createClient –¥–æ—Å—Ç—É–ø–µ–Ω');
                logTo(log, '‚úÖ Supabase SDK –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω');
                updateProgress();
            } else {
                status.className = 'status error';
                status.textContent = '‚ùå Supabase SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω';
                logTo(log, '‚ùå createClient –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω');
                logTo(log, '‚ùå Supabase SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        function checkAuthFunctions() {
            const status = document.getElementById('authFunctionsStatus');
            const log = 'authFunctionsLog';
            
            logTo(log, 'üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏...');
            
            const functions = ['signInWithGitHub', 'registerUser', 'loginUser', 'logoutUser', 'onAuthStateChange', 'getCurrentUser'];
            const missing = functions.filter(f => typeof window[f] === 'undefined');
            
            if (missing.length === 0) {
                status.className = 'status success';
                status.textContent = '‚úÖ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã';
                logTo(log, '‚úÖ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞–π–¥–µ–Ω—ã');
                functions.forEach(f => logTo(log, `‚úÖ ${f} –¥–æ—Å—Ç—É–ø–Ω–∞`));
                updateProgress();
            } else {
                status.className = 'status error';
                status.textContent = `‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ñ—É–Ω–∫—Ü–∏–∏: ${missing.join(', ')}`;
                logTo(log, `‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ñ—É–Ω–∫—Ü–∏–∏: ${missing.join(', ')}`);
                functions.forEach(f => {
                    if (missing.includes(f)) {
                        logTo(log, `‚ùå ${f} –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç`);
                    } else {
                        logTo(log, `‚úÖ ${f} –¥–æ—Å—Ç—É–ø–Ω–∞`);
                    }
                });
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        function checkInitialization() {
            const status = document.getElementById('initializationStatus');
            const log = 'initializationLog';
            
            logTo(log, 'üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é...');
            
            try {
                if (typeof initSupabase !== 'undefined') {
                    logTo(log, '‚úÖ –§—É–Ω–∫—Ü–∏—è initSupabase –¥–æ—Å—Ç—É–ø–Ω–∞');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ª–∏ Supabase
                    if (typeof supabase !== 'undefined' && supabase !== null) {
                        status.className = 'status success';
                        status.textContent = '‚úÖ Supabase –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω';
                        logTo(log, '‚úÖ Supabase –∫–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω');
                        updateProgress();
                    } else {
                        status.className = 'status warning';
                        status.textContent = '‚ö†Ô∏è Supabase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω';
                        logTo(log, '‚ö†Ô∏è Supabase –∫–ª–∏–µ–Ω—Ç –Ω–µ —Å–æ–∑–¥–∞–Ω');
                    }
                } else {
                    status.className = 'status error';
                    status.textContent = '‚ùå –§—É–Ω–∫—Ü–∏—è initSupabase –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
                    logTo(log, '‚ùå –§—É–Ω–∫—Ü–∏—è initSupabase –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                }
            } catch (error) {
                status.className = 'status error';
                status.textContent = `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ${error.message}`;
                logTo(log, `‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
            }
        }
        
        // –¢–µ—Å—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        async function testRegistration() {
            const result = document.getElementById('registrationResult');
            const btn = document.getElementById('registerBtn');
            
            try {
                btn.disabled = true;
                const email = document.getElementById('testEmail').value;
                const password = document.getElementById('testPassword').value;
                
                if (typeof registerUser === 'undefined') {
                    result.innerHTML = '<div class="status error">‚ùå –§—É–Ω–∫—Ü–∏—è registerUser –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞</div>';
                    return;
                }
                
                result.innerHTML = '<div class="status info">üîÑ –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º...</div>';
                const user = await registerUser(email, password, email);
                result.innerHTML = `<div class="status success">‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞: ${user.email}</div>`;
                updateProgress();
                checkUserStatus();
            } catch (error) {
                result.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
            }
        }
        
        // –¢–µ—Å—Ç –≤—Ö–æ–¥–∞
        async function testLogin() {
            const result = document.getElementById('loginResult');
            const btn = document.getElementById('loginBtn');
            
            try {
                btn.disabled = true;
                const email = document.getElementById('testEmail').value;
                const password = document.getElementById('testPassword').value;
                
                if (typeof loginUser === 'undefined') {
                    result.innerHTML = '<div class="status error">‚ùå –§—É–Ω–∫—Ü–∏—è loginUser –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞</div>';
                    return;
                }
                
                result.innerHTML = '<div class="status info">üîÑ –í—Ö–æ–¥–∏–º...</div>';
                const user = await loginUser(email, password);
                result.innerHTML = `<div class="status success">‚úÖ –í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω: ${user.email}</div>`;
                updateProgress();
                checkUserStatus();
            } catch (error) {
                result.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
            }
        }
        
        // –¢–µ—Å—Ç –≤—ã—Ö–æ–¥–∞
        async function testLogout() {
            const result = document.getElementById('logoutResult');
            const btn = document.getElementById('logoutBtn');
            
            try {
                btn.disabled = true;
                if (typeof logoutUser === 'undefined') {
                    result.innerHTML = '<div class="status error">‚ùå –§—É–Ω–∫—Ü–∏—è logoutUser –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞</div>';
                    return;
                }
                
                result.innerHTML = '<div class="status info">üîÑ –í—ã—Ö–æ–¥–∏–º...</div>';
                await logoutUser();
                result.innerHTML = '<div class="status success">‚úÖ –í—ã—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω</div>';
                updateProgress();
                checkUserStatus();
            } catch (error) {
                result.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function checkUserStatus() {
            const status = document.getElementById('userStatus');
            try {
                if (typeof getCurrentUser === 'undefined') {
                    status.className = 'status error';
                    status.textContent = '‚ùå –§—É–Ω–∫—Ü–∏—è getCurrentUser –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞';
                    return;
                }
                
                const user = await getCurrentUser();
                if (user) {
                    status.className = 'status success';
                    status.textContent = `‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: ${user.email}`;
                } else {
                    status.className = 'status info';
                    status.textContent = 'üë§ –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
                }
            } catch (error) {
                status.className = 'status error';
                status.textContent = `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ${error.message}`;
            }
        }
        
        // –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
        function runFullDiagnostic() {
            const log = 'diagnosticLog';
            logTo(log, 'üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
            setTimeout(() => checkSupabase(), 100);
            setTimeout(() => checkAuthFunctions(), 200);
            setTimeout(() => checkInitialization(), 300);
            setTimeout(() => checkUserStatus(), 400);
            
            logTo(log, '‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞');
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', function() {
            setTimeout(() => {
                checkSupabase();
                setTimeout(() => {
                    checkAuthFunctions();
                    setTimeout(() => {
                        checkInitialization();
                        setTimeout(() => {
                            checkUserStatus();
                        }, 500);
                    }, 500);
                }, 500);
            }, 1000);
        });
        
        // –°–ª—É—à–∞—Ç–µ–ª—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        if (typeof onAuthStateChange !== 'undefined') {
            onAuthStateChange((user) => {
                if (user) {
                    console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª:', user.email);
                    checkUserStatus();
                } else {
                    console.log('üëã –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª');
                    checkUserStatus();
                }
            });
        }
    </script>
</body>
</html>
