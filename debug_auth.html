<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { margin: 5px; padding: 10px 15px; border: none; background: #007bff; color: white; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</h1>
    
    <div id="results"></div>
    
    <button onclick="runFullDiagnostic()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</button>
    <button onclick="testServerHealth()">üè• –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</button>
    <button onclick="testUserCreation()">üë§ –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
    <button onclick="testLogin()">üîê –¢–µ—Å—Ç–æ–≤—ã–π –≤—Ö–æ–¥</button>
    <button onclick="clearLogs()">üßπ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
    
    <div id="logs" class="log"></div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase –≤–º–µ—Å—Ç–æ –≤–Ω–µ—à–Ω–µ–≥–æ API
        const supabaseUrl = 'https://xykhpnksatwipwcmxwyn.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5a2hwbmtzYXR3aXB3Y214d3luIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNTAyNjIsImV4cCI6MjA3MDgyNjI2Mn0.PSARsuv14dI7xq35xvgVoxwjptb4cm8Ywb3bYZhY0KM';
        const supabase = createClient(supabaseUrl, supabaseKey);
        
        let testUser = {
            email: 'test-debug-' + Date.now() + '@example.com',
            password: 'testpass123'
        };

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('logs');
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function showResult(message, type) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = message;
            resultsDiv.appendChild(resultDiv);
        }

        function clearLogs() {
            document.getElementById('logs').textContent = '';
            document.getElementById('results').innerHTML = '';
        }

        async function testServerHealth() {
            log('üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è Supabase...');
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase
                const { data, error } = await supabase.from('user_profiles').select('count').limit(1);
                
                if (!error) {
                    log(`‚úÖ Supabase —Ä–∞–±–æ—Ç–∞–µ—Ç. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∞.`);
                    showResult(`‚úÖ Supabase –∑–¥–æ—Ä–æ–≤. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∞.`, 'success');
                    return true;
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ Supabase: ${error.message}`);
                    showResult(`‚ùå Supabase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${error.message}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ${error.message}`);
                showResult(`‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
                return false;
            }
        }

        async function testUserCreation() {
            log(`üë§ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${testUser.email}`);
            try {
                const { data, error } = await supabase.auth.signUp({
                    email: testUser.email,
                    password: testUser.password
                });
                
                if (!error && data.user) {
                    log(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω. ID: ${data.user.id}`);
                    showResult(`‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω.`, 'success');
                    testUser.id = data.user.id;
                    return true;
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${data.error}`);
                    showResult(`‚ùå –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: ${data.error}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${error.message}`);
                showResult(`‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${error.message}`, 'error');
                return false;
            }
        }

        async function testLogin() {
            log(`üîê –¢–µ—Å—Ç–æ–≤—ã–π –≤—Ö–æ–¥ —Å: ${testUser.email}`);
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: testUser.email,
                    password: testUser.password
                });
                
                if (!error && data.user) {
                    log(`‚úÖ –í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${data.user.email}`);
                    showResult(`‚úÖ –í—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.`, 'success');
                    
                    // –ü—Ä–æ–≤–µ—Ä–∏–º –ø–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    await testGetUserProfile(data.user.id);
                    return true;
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${error.message}`);
                    showResult(`‚ùå –í—Ö–æ–¥ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: ${error.message}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ: ${error.message}`);
                showResult(`‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${error.message}`, 'error');
                return false;
            }
        }

        async function testGetUserProfile(userId) {
            log(`üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...`);
            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (!error && data) {
                    log(`‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—É—á–µ–Ω: ${JSON.stringify(data, null, 2)}`);
                    showResult(`‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.`, 'success');
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: ${error.message}`);
                    showResult(`‚ùå –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: ${error.message}`, 'error');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è: ${error.message}`);
                showResult(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: ${error.message}`, 'error');
            }
        }

        async function testExistingUser() {
            log(`üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥–∞ —Å kirill2@mail.ru...`);
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: 'kirill2@mail.ru',
                    password: '12345'
                });
                
                if (!error && data.user) {
                    log(`‚úÖ kirill2@mail.ru —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç!`);
                    showResult(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å kirill2@mail.ru —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.`, 'success');
                } else {
                    log(`‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å kirill2@mail.ru: ${error.message}`);
                    showResult(`‚ùå kirill2@mail.ru –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: ${error.message}`, 'error');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ kirill2@mail.ru: ${error.message}`);
                showResult(`‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ kirill2@mail.ru: ${error.message}`, 'error');
            }
        }

        async function runFullDiagnostic() {
            clearLogs();
            log('üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã...');
            
            // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
            const serverOk = await testServerHealth();
            if (!serverOk) {
                log('‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.');
                return;
            }
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await testExistingUser();
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 3. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userCreated = await testUserCreation();
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 4. –¢–µ—Å—Ç –≤—Ö–æ–¥–∞
            if (userCreated) {
                await testLogin();
            }
            
            log('üèÅ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
            showResult('üèÅ –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã—à–µ.', 'info');
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            log('üì± –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            log('üîß –ì–æ—Ç–æ–≤ –∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ —Å–∏—Å—Ç–µ–º—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');
        });
    </script>
</body>
</html>

