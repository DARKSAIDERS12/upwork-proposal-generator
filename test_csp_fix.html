<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: http:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https: http:; style-src 'self' 'unsafe-inline' https: http:; img-src 'self' data: https: http:; font-src 'self' https: http:; connect-src 'self' https: http:;">
    <title>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π CSP</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .csp-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <h1>üîí –¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π CSP</h1>
    
    <div class="csp-info">
        <h3>‚ÑπÔ∏è Content Security Policy</h3>
        <p>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—É—é –ø–æ–ª–∏—Ç–∏–∫—É CSP –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è XSS –∞—Ç–∞–∫.</p>
        <p><strong>–†–∞–∑—Ä–µ—à–µ–Ω–æ:</strong> inline —Å–∫—Ä–∏–ø—Ç—ã, eval, –≤–Ω–µ—à–Ω–∏–µ —Ä–µ—Å—É—Ä—Å—ã</p>
        <p><strong>–ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è:</strong> –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ inline –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏</p>
    </div>
    
    <div class="test-section">
        <h2>1. üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ CSP</h2>
        <div id="cspStatus" class="status info">–ü—Ä–æ–≤–µ—Ä—è–µ–º...</div>
        <button id="cspTestBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å CSP</button>
        <div class="log" id="cspLog"></div>
    </div>
    
    <div class="test-section">
        <h2>2. üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</h2>
        <div id="authStatus" class="status info">–ü—Ä–æ–≤–µ—Ä—è–µ–º...</div>
        <button id="authTestBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é</button>
        <div class="log" id="authLog"></div>
    </div>
    
    <div class="test-section">
        <h2>3. üìù –¢–µ—Å—Ç —Ñ–æ—Ä–º</h2>
        <div id="formStatus" class="status info">–ü—Ä–æ–≤–µ—Ä—è–µ–º...</div>
        <button id="formTestBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º—ã</button>
        <div class="log" id="formLog"></div>
    </div>
    
    <div class="test-section">
        <h2>4. üöÄ –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h2>
        <button id="fullTestBtn">–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç</button>
        <div class="log" id="fullLog"></div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Auth.js -->
    <script src="auth.js"></script>
    
    <script>
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        function logTo(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                const timestamp = new Date().toLocaleTimeString();
                element.innerHTML += `[${timestamp}] ${message}\n`;
                element.scrollTop = element.scrollHeight;
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ CSP
        function testCSP() {
            const status = document.getElementById('cspStatus');
            const log = 'cspLog';
            
            logTo(log, 'üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º Content Security Policy...');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ CSP –º–µ—Ç–∞-—Ç–µ–≥ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                const cspMeta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
                if (cspMeta) {
                    logTo(log, '‚úÖ CSP –º–µ—Ç–∞-—Ç–µ–≥ –Ω–∞–π–¥–µ–Ω');
                    logTo(log, `üìã CSP: ${cspMeta.content}`);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ inline —Å–∫—Ä–∏–ø—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç
                    const testElement = document.createElement('div');
                    testElement.innerHTML = '<script>console.log("CSP inline test");<\/script>';
                    document.body.appendChild(testElement);
                    document.body.removeChild(testElement);
                    
                    status.className = 'status success';
                    status.textContent = '‚úÖ CSP –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ';
                    logTo(log, '‚úÖ Inline —Å–∫—Ä–∏–ø—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç');
                } else {
                    throw new Error('CSP –º–µ—Ç–∞-—Ç–µ–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
            } catch (error) {
                status.className = 'status error';
                status.textContent = `‚ùå –û—à–∏–±–∫–∞ CSP: ${error.message}`;
                logTo(log, `‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        function testAuth() {
            const status = document.getElementById('authStatus');
            const log = 'authLog';
            
            logTo(log, 'üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏—Å—Ç–µ–º—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏...');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º Supabase SDK
                if (typeof createClient === 'undefined') {
                    throw new Error('Supabase SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                }
                logTo(log, '‚úÖ Supabase SDK –∑–∞–≥—Ä—É–∂–µ–Ω');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                const functions = ['signInWithGitHub', 'registerUser', 'loginUser', 'logoutUser'];
                const missing = functions.filter(f => typeof window[f] === 'undefined');
                
                if (missing.length === 0) {
                    status.className = 'status success';
                    status.textContent = '‚úÖ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã';
                    logTo(log, '‚úÖ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞–π–¥–µ–Ω—ã');
                } else {
                    throw new Error(`–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ñ—É–Ω–∫—Ü–∏–∏: ${missing.join(', ')}`);
                }
            } catch (error) {
                status.className = 'status error';
                status.textContent = `‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${error.message}`;
                logTo(log, `‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º
        function testForms() {
            const status = document.getElementById('formStatus');
            const log = 'formLog';
            
            logTo(log, 'üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º—ã...');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–æ—Ä–º—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
                const loginForm = document.getElementById('loginFormElement');
                const registerForm = document.getElementById('registerFormElement');
                
                if (!loginForm || !registerForm) {
                    throw new Error('–§–æ—Ä–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                }
                logTo(log, '‚úÖ –§–æ—Ä–º—ã –Ω–∞–π–¥–µ–Ω—ã');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ—Ç inline onclick
                const inlineOnclick = document.querySelectorAll('[onclick]');
                if (inlineOnclick.length > 0) {
                    throw new Error(`–ù–∞–π–¥–µ–Ω—ã inline onclick: ${inlineOnclick.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤`);
                }
                logTo(log, '‚úÖ Inline onclick –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å data-–∞—Ç—Ä–∏–±—É—Ç—ã
                const dataTabs = document.querySelectorAll('[data-tab]');
                if (dataTabs.length === 0) {
                    throw new Error('Data-–∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                }
                logTo(log, '‚úÖ Data-–∞—Ç—Ä–∏–±—É—Ç—ã –Ω–∞–π–¥–µ–Ω—ã');
                
                status.className = 'status success';
                status.textContent = '‚úÖ –§–æ—Ä–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ';
                logTo(log, '‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã');
                
            } catch (error) {
                status.className = 'status error';
                status.textContent = `‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º: ${error.message}`;
                logTo(log, `‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
            }
        }
        
        // –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
        function runFullTest() {
            const log = 'fullLog';
            logTo(log, 'üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...');
            
            setTimeout(() => testCSP(), 100);
            setTimeout(() => testAuth(), 200);
            setTimeout(() => testForms(), 300);
            
            logTo(log, '‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞');
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            const cspBtn = document.getElementById('cspTestBtn');
            const authBtn = document.getElementById('authTestBtn');
            const formBtn = document.getElementById('formTestBtn');
            const fullBtn = document.getElementById('fullTestBtn');
            
            if (cspBtn) cspBtn.addEventListener('click', testCSP);
            if (authBtn) authBtn.addEventListener('click', testAuth);
            if (formBtn) formBtn.addEventListener('click', testForms);
            if (fullBtn) fullBtn.addEventListener('click', runFullTest);
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', function() {
            setupEventListeners();
            setTimeout(() => {
                testCSP();
                setTimeout(() => {
                    testAuth();
                    setTimeout(() => {
                        testForms();
                    }, 500);
                }, 500);
            }, 1000);
        });
    </script>
</body>
</html>
